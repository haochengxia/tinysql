## 5.3 操作符优先级

> English Version: https://www.gnu.org/software/bison/manual/html_node/Precedence.html#Precedence
>
> Translated by Percy at 2021/03/10 22:00

移进规约冲突的另一种发生场景为算数表达式。此时移进并不总是优先的解决方案，Bison对操作符的优先级声明允许你明确什么时候移进什么时候规约。



### 5.3.1 为什么需要优先级

考虑下面的歧义语法片段（歧义是由于输入`1 - 2 * 3` 可以被解析为两种形式：

```
expr:
  expr '-' expr
| expr '*' expr
| expr '<' expr
| '(' expr ')'
…
;
```

假设语法分析器见到标志`1`，`-` 和 `2`，它是否应该按照针对减号的规则规约它们呢？这取决于下一个标志。当然，如果下一个标志是`)`，我们必须进行规约；移进是无效的因为没有任何规则能够规约标志序列`- 2 )` 或者任何的以它为起始的序列。但是如果下一个标志是`*` 或者 `<`，我们就有了一个选择：无论是移进还是规约都能完成解析，但会带来不同的结果。

为了确定Bison应该进行哪一个动作，我们必须首先考虑结果。如果下一个操作符标志被移进了，那么它为了允许另一个规约必须被先规约。结果就为`1 - (2 op 3)`。另一面，如果减号先被规约了，结果就是`(1 - 2) op 3`。显然此时选择移进还是规约取决于操作符`-`和`op`的相对优先级：`*`应该先移进，`<`则不是。

那么如果输入是`1 - 2 - 5`呢？应该是`(1 - 2) - 5`还是`1 - (2 - 5)`？对于大多数操作符我们都倾向于前者，这就叫做左结合。后者就叫又结合，适用于赋值符号。结合性的选择关乎语法分析器在栈内包含`1 - 2`并且下一个表示是`-`的时候是选择移进还是规约，如果是右结合，那就会移进。

### 5.3.2 声明操作符优先级

Bison允许你同时优先级声明 `%left` 和 `%right`来明确操作符的结合性。

| declarations | description                                                  |
| ------------ | ------------------------------------------------------------ |
| %left        | 使得后面的操作符为左结合                                     |
| %right       | 使得后面的操作符为右结合                                     |
| %nonassoc    | 表示在“同一行”中出现此操作符两次是语法错误                   |
| %precedence  | 只定义优先级而不定义结合性，任何结合性冲突会被报告为编译时错误 |

指令`%nonassoc`创造运行时错误：以结合性的方式使用操作符是语法错误；

指令`%precedence`创造编译时错误：与语法作者所期望的相反，操作符可能会涉及与关联性相关的冲突。

不同操作符间的相对优先级是由定义时的次序决定的，定义越靠前，优先级越低。

### 5.3.3 仅声明优先级

因为POSIX Yacc只定义了`%left`, `%right`, 和`%nonassoc`，而这三者都是同时定义优先级和结合性的，而没人关注在这个情况下优先级是不能被独立定义的。但有些是有为了解决冲突，只定义优先级就够用了。在这样的情形中，用`%left`, `%right`, 或 `%nonassoc` 可能会隐含一些结合性相关的冲突。

悬垂`else`歧义可以被明确地解决。这个移进规约冲突发生在下面的情形中( • 表示当前解析状态)：

```
if e1 then if  e2 then s1 • else s2
```

此冲突涉及规约规则 ‘IF expr THEN stmt’, 其优先级应该默认就是最后一个标志（`Then`）和标志`else`的移进。常规的消除歧义方法就是匹配`else`到最近的`if`，也就是优先移进。即ELSE的优先级必须高于THEN的优先级。但是，预计两者都不会涉及与结合性相关的冲突，可以将其指定如下。

```
%precedence THEN
%precedence ELSE
```

一元减号是另一个通常过度指定结合性的典型示例，参见 [Infix Notation Calculator：`calc`](https://www.gnu.org/software/bison/manual/html_node/Infix-Calc.html)。传统上，％left指令用于声明`NEG`的优先级，因为它还超出需要地定义了其结合性。尽管在传统示例中这是无害的，但并不能断定`NEG`在语法的未来发展中的使用。

### 5.3.4 优先级示例

在我们的例子中，需要以下声明：

```
%left '<'
%left '-'
%left '*'
```

而在一个更加完整的、支持其他操作符的例子里，我们要定义一些操作符在一个同等优先级的组中:

```
%left '<' '>' '=' "!=" "<=" ">="
%left '+' '-'
%left '*' '/'
```

### 5.3.5 优先级工作原理

优先级声明的影响有二：

一、将优先级分配给声明的终端符号；

二、为某些规则分配优先级：每个规则都从规则组成部分中提到的最后一个终端符号获得其优先级；

 (如何显式地声明规则的优先级。 参见 [Context-Dependent Precedence](https://www.gnu.org/software/bison/manual/html_node/Contextual-Precedence.html).)

最后，比较正在考虑的规则和下一个标志的优先级，可以解决冲突。如果下一个标志的优先级更高，选择移进；如果相反就规约。如果具有相同的优先级，那就根据优先级的结合性进行选择。相机输出文件可以使用 `-v` 命令生成，描述了每个解决每个冲突的方式。

并非所有规则和所有标志都具有优先权。如果规则或先行标志没有优先级，则默认为移进。

### 5.3.6 对非操作符应用优先级

正确使用优先级和结合性指令可以帮助解决不涉及类似算术运算符的移进规约冲突。例如，“悬垂`else`”（请参阅[Shift / Reduce Conflicts](https://www.gnu.org/software/bison/manual/html_node/Shift_002fReduce.html)部分）可以很好地以两种不同的方式被解决。

在当前情况下，冲突在于愿意移进的标志“ else”与规则“ if_stmt：“ if” expr“ then” stmt”之间的冲突，此规则要求规约。默认情况下，规则的优先级是其最后一个标记的优先级，这里是“ then”，因此可以通过为“ else”赋予比“ then”更高的优先级来适当地解决冲突。如下：

```
%precedence "then"
%precedence "else"
```

或者，也可以为两个标记赋予相同的优先级，在这种情况下，可以使用结合性解决冲突。要保留移进动作，使用正确的结合性：

```
%right "then" "else"
```

但是，这两种解决方案都不完美。到目前为止，由于Bison尚未提供“作用域”优先级，因此两者都迫使用户声明这些关键字相对于语法中其他操作符的优先级。这导致用户将不会被警告而不是被警告有新的冲突。例如，“ if test then 1 else 2 + 3“存在歧义，可以被解析为“ if test then 1 else (2 + 3)”或”（if test then 1 else 2) + 3“。

